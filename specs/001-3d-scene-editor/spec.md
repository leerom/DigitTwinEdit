# 功能规格说明书: 数字孪生三维场景编辑器

**功能分支**: `001-3d-scene-editor`
**创建日期**: 2026-01-20
**状态**: 草稿
**输入**: 用户描述: "功能需求请参考rawRequirements目录下的文档UI界面要求"

---

## 目录

1. [用户场景与测试](#用户场景与测试-必填)
2. [需求](#需求-必填)
3. [关键实体](#关键实体)
4. [成功标准](#成功标准-必填)
5. [假设条件](#假设条件)
6. [澄清记录](#澄清记录)

---

## 用户场景与测试 *(必填)*

### 用户故事 1 - 场景视图导航 (优先级: P1)

作为一名三维场景编辑器用户，我希望能够使用鼠标和键盘自由导航场景视图，以便从任何角度和位置检查对象。

**优先级理由**: 核心功能 - 没有导航，用户根本无法与三维场景交互。这是所有其他编辑操作的基础。

**独立测试**: 可以通过加载示例场景并验证所有导航控件（平移、旋转、缩放、飞行漫游）是否正常工作来完全测试，而无需编辑任何对象。

**验收场景**:

1. **给定** 加载了三维场景，**当** 用户按住 Alt+左键并拖动时，**则** 视图围绕场景中心平滑旋转。

2. **给定** 加载了三维场景，**当** 用户滚动鼠标滚轮时，**则** 视图以一致的速率放大/缩小。

3. **给定** 加载了三维场景，**当** 用户按住鼠标中键并拖动时，**则** 视图沿拖动方向平移。

4. **给定** 抓手工具 (Q) 已激活，**当** 用户左键点击并拖动时，**则** 视图平移且光标显示"手形"图标。

5. **给定** 加载了三维场景，**当** 用户按住鼠标右键并配合 WASD 键时，**则** 飞行漫游模式激活，光标显示"眼睛"图标。

6. **给定** 选中了一个对象，**当** 用户按下 F 键时，**则** 视图居中并聚焦于选中的对象。

7. **给定** 视图错位，**当** 用户 Shift+点击坐标轴中心时，**则** 视图重置为默认透视角度。

---

### 用户故事 2 - 对象选择与层级同步 (优先级: P1)

作为一名场景编辑器用户，我希望能在场景视图或层级面板中选择对象，并看到选择状态在两个视图之间同步。

**优先级理由**: 选择是任何编辑操作的基础 - 用户必须先选择对象才能修改它们。

**独立测试**: 可以通过在场景视图中点击对象并验证层级面板高亮显示，反之亦然来测试。

**验收场景**:

1. **给定** 场景中有多个对象，**当** 用户在场景视图中左键点击一个对象时，**则** 该对象在场景视图和层级面板中都被选中并高亮显示。

2. **给定** 场景中有多个对象，**当** 用户在层级面板中点击一个对象时，**则** 该对象在场景视图中被选中并高亮显示。

3. **给定** 没有选中对象，**当** 用户左键拖动绘制选择框时，**则** 鼠标释放后框内的所有对象都被选中。

4. **给定** 选中了一个对象，**当** 用户 Ctrl+点击另一个未选中的对象时，**则** 两个对象现在都被选中（加选）。

5. **给定** 选中了多个对象，**当** 用户 Alt+点击一个已选中的对象时，**则** 该对象被取消选中，而其他对象保持选中状态。

6. **给定** 场景中有对象，**当** 用户按下 Ctrl+A 时，**则** 场景中的所有对象都被选中。

7. **给定** 选中了对象，**当** 用户点击场景视图中的空白区域时，**则** 所有选择都被清除。

---

### 用户故事 3 - 变换工具操作 (优先级: P1)

作为一名场景编辑器用户，我希望使用变换工具（移动/旋转/缩放）在三维场景中直观地编辑对象的位置、旋转和缩放。

**优先级理由**: 变换操作是核心编辑能力，允许用户在场景中排列和修改对象。

**独立测试**: 可以通过选择一个对象并使用每个变换工具修改其属性，然后验证检查器面板中的更改来测试。

**验收场景**:

1. **给定** 移动工具 (W) 已激活且选中了对象，**当** 工具激活时，**则** 显示 XYZ 轴箭头（红-X，绿-Y，蓝-Z）。

2. **给定** 移动工具已激活，**当** 用户拖动 X 轴箭头时，**则** 对象仅沿 X 轴移动。

3. **给定** 旋转工具 (E) 已激活且选中了对象，**当** 工具激活时，**则** 显示相应颜色的 XYZ 旋转环。

4. **给定** 旋转工具已激活，**当** 用户拖动 Y 轴环时，**则** 对象仅绕 Y 轴旋转。

5. **给定** 缩放工具 (R) 已激活且选中了对象，**当** 用户拖动中心立方体时，**则** 对象在所有轴上均匀缩放。

6. **给定** 通用工具 (Y) 已激活，**当** 工具激活时，**则** 移动、旋转和缩放控件同时显示。

7. **给定** 任何变换工具已激活，**当** 用户按住 Shift 键拖动时，**则** 变换操作加速。

8. **给定** 选中了一个对象，**当** 用户按下 Ctrl+Shift+Z 时，**则** 变换属性重置为默认值（位置：原点，旋转：0，缩放：1）。

---

### 用户故事 4 - 渲染模式切换 (优先级: P2)

作为一名场景编辑器用户，我希望在不同的渲染模式（线框/着色/线框+着色）之间切换，以检查对象几何结构和视觉外观。

**优先级理由**: 对模型检查和调试很重要，但对于基本的场景编辑工作流不是必需的。

**独立测试**: 可以通过切换每个渲染模式按钮并验证视觉输出相应变化来测试。

**验收场景**:

1. **给定** 场景视图已打开，**当** 用户点击"线框"模式按钮时，**则** 所有对象仅渲染为线框，无纹理/材质。

2. **给定** 场景视图已打开，**当** 用户点击"着色"模式按钮时，**则** 所有对象渲染完整的材质、纹理和光照。

3. **给定** 场景视图已打开，**当** 用户点击"线框+着色"模式按钮时，**则** 对象显示带有线框叠加的材质。

4. **给定** 一个渲染模式已激活，**当** 用户点击不同的模式时，**则** 新模式激活，前一个模式停用（互斥）。

5. **给定** 一个渲染模式已激活，**当** 选择该模式时，**则** 清晰的视觉指示器（高亮/边框）显示哪个模式处于活动状态。

---

### 用户故事 5 - 检查器属性编辑 (优先级: P2)

作为一名场景编辑器用户，我希望在检查器面板中查看和编辑选中对象的属性，包括变换值、材质和数字孪生数据。

**优先级理由**: 对于精确编辑至关重要，但用户也可以使用变换工具进行视觉编辑。

**独立测试**: 可以通过选择对象并在检查器中修改值，验证更改应用于场景对象来测试。

**验收场景**:

1. **给定** 选中了一个对象，**当** 检查器打开时，**则** 变换部分显示带有 X/Y/Z 输入的位置、旋转、缩放值。

2. **给定** 选中了一个对象，**当** 用户在检查器中修改位置 X 值时，**则** 对象在场景视图中立即沿 X 轴移动。

3. **给定** 选中了一个对象，**当** 用户按下 F2 时，**则** 对象名称变为可编辑状态以进行重命名。

4. **给定** 一个带有材质的对象，**当** 被选中时，**则** 检查器显示带有视觉控件的材质属性（粗糙度、金属度等）。

5. **给定** 选中了一个数字孪生对象，**当** 检查器打开时，**则** 数字孪生数据部分显示外部 ID、实时传感器值（通过模拟数据生成）和连接状态。

---

### 用户故事 6 - 层级树管理 (优先级: P2)

作为一名场景编辑器用户，我希望将场景对象层级结构视为树状结构，并通过拖放管理父子关系。

**优先级理由**: 对场景组织很重要，但基本编辑可以在没有层级更改的情况下工作。

**独立测试**: 可以通过展开/折叠节点并拖动对象以更改父子关系来测试。

**验收场景**:

1. **给定** 加载了场景，**当** 层级面板显示时，**则** 所有场景对象显示在带有展开/折叠控件的树状结构中。

2. **给定** 一个对象有子对象，**当** 用户点击展开箭头时，**则** 子对象在父对象下方缩进显示。

3. **给定** 层级中存在对象，**当** 用户将对象 A 拖到对象 B 上时，**则** 对象 A 成为对象 B 的子对象。

4. **给定** 层级中的选中对象，**当** 显示选择状态时，**则** 它显示带有高亮背景和左侧边框指示器。

---

### 用户故事 7 - 项目资源管理 (优先级: P3)

作为一名场景编辑器用户，我希望在项目面板中浏览项目资产，并将资源拖入场景以创建新对象。

**优先级理由**: 对内容创建很重要，但用户可以在不添加新资源的情况下使用现有场景对象工作。

**独立测试**: 可以通过导航文件夹结构并将资产拖入场景来测试。

**验收场景**:

1. **给定** 项目面板已打开，**当** 用户导航文件夹树时，**则** 内容区域显示所选文件夹中的文件及缩略图（资产从本地静态文件加载）。

2. **给定** 可见 3D 模型资产，**当** 用户将其拖入场景视图时，**则** 在放置位置创建新的对象实例。

3. **给定** 项目面板，**当** 用户切换到"资源"标签页时，**则** 显示公共资产库内容以供浏览。

4. **给定** 资产库中的资源，**当** 用户将其拖入场景时，**则** 导入并实例化该资源。

---

### 用户故事 8 - 对象操作 (复制/删除/撤销) (优先级: P3)

作为一名场景编辑器用户，我希望对场景对象进行复制、删除和撤销/重做操作，以提高编辑工作流效率。

**优先级理由**: 提高编辑速度的便利功能，但对于基本功能不是严格必需的。

**独立测试**: 可以通过执行复制、删除、撤销操作并验证场景状态更改来测试。

**验收场景**:

1. **给定** 选中了一个对象，**当** 用户按下 Ctrl+D 时，**则** 在相同位置创建一个重复对象。

2. **给定** 选中了一个对象，**当** 用户按下 Delete 键时，**则** 删除前出现确认对话框。

3. **给定** 选中了一个对象，**当** 用户按下 Shift+Delete 时，**则** 对象立即删除，无确认。

4. **给定** 刚刚执行了一个操作，**当** 用户按下 Ctrl+Z 时，**则** 撤销该操作。

5. **给定** 刚刚撤销了一个操作，**当** 用户按下 Ctrl+Y 时，**则** 重做该操作。

---

### 边界情况

- 当用户尝试在未选中对象的情况下变换对象时会发生什么？→ 工具显示但不显示 Gizmo；工具提示建议选择对象。
- 系统如何处理极度放大/缩小的视图状态？→ 实现缩放限制，防止视图进入对象内部或丢失场景视图。
- 当用户在层级中将父对象拖到其自己的子对象上时会发生什么？→ 操作被拒绝并提供视觉反馈；不允许循环引用。
- 飞行漫游模式在场景边界的行为如何？→ 无硬性限制；用户可以自由导航，但应能轻松重置视图。
- 当用户将变换值编辑为无效数字（NaN，极大值）时会发生什么？→ 输入被拒绝；恢复之前的有效值并提供错误指示。
- 系统如何处理选择位于其他对象后面的对象？→ 射线投射选择最前面的对象；用户可以使用层级面板选择被遮挡的对象。

---

## 需求 *(必填)*

### 功能需求

#### 场景视图核心

- **功能需求-001**: 系统必须提供一个 3D 视口，实时渲染场景对象、网格、灯光和相机。
- **功能需求-002**: 系统必须支持 3D 透视视图和 2D 正交视图模式。
- **功能需求-003**: 系统必须在右下角显示坐标轴辅助工具，显示 X(红)/Y(绿)/Z(蓝) 方向。
- **功能需求-004**: 系统必须在视口叠加层中显示性能统计信息（绘制调用、三角形、顶点）。
- **功能需求-059**: 系统必须支持通过浏览器文件下载将当前场景保存为 JSON 文件。

#### 导航

- **功能需求-005**: 系统必须支持通过 Alt+左键拖动旋转视图（仅 3D 模式）。
- **功能需求-006**: 系统必须支持通过鼠标滚轮或 Alt+右键拖动缩放视图。
- **功能需求-007**: 系统必须支持通过中键拖动或 Q 工具+左键拖动平移视图。
- **功能需求-008**: 系统必须支持在按住右键的同时进行飞行漫游导航（WASD/QE 移动）（仅 3D 模式）。
- **功能需求-009**: 系统必须更改光标图标以反映当前模式：箭头（默认）、手形（平移）、眼睛（飞行漫游）。
- **功能需求-010**: 系统必须在按住 Shift 键时加速所有导航操作。
- **功能需求-011**: 系统必须支持方向键导航以平移视图。

#### 选择

- **功能需求-012**: 系统必须支持通过左键单击进行单对象选择。
- **功能需求-013**: 系统必须支持通过左键拖动进行框选。
- **功能需求-014**: 系统必须支持通过 Ctrl+单击进行加选。
- **功能需求-015**: 系统必须支持通过 Alt+单击进行减选。
- **功能需求-016**: 系统必须支持通过 Ctrl+A 全选。
- **功能需求-017**: 系统必须在场景视图和层级面板之间双向同步选择状态。

#### 变换工具

- **功能需求-018**: 系统必须提供抓手工具 (Q) 用于仅视图导航。
- **功能需求-019**: 系统必须提供移动工具 (W)，显示 XYZ 轴箭头用于位置编辑。
- **功能需求-020**: 系统必须提供旋转工具 (E)，显示 XYZ 轴环用于旋转编辑。
- **功能需求-021**: 系统必须提供缩放工具 (R)，显示 XYZ 轴立方体用于缩放编辑。
- **功能需求-022**: 系统必须提供通用工具 (Y)，组合移动/旋转/缩放控件。
- **功能需求-023**: 系统必须对变换 Gizmo 进行颜色编码：X 轴（红），Y 轴（绿），Z 轴（蓝）。
- **功能需求-024**: 系统必须支持键盘快捷键 Q/W/E/R/Y 进行工具切换。
- **功能需求-025**: 系统必须在按住 Shift 键时加速变换操作。
- **功能需求-026**: 系统必须通过视觉指示器高亮工具栏中当前活动的工具。
- **功能需求-027**: 系统必须在未选中对象时隐藏变换 Gizmo（抓手工具除外）。

#### 渲染模式

- **功能需求-028**: 系统必须提供线框渲染模式，仅显示对象几何线条。
- **功能需求-029**: 系统必须提供着色渲染模式，显示完整的材质和光照（默认）。
- **功能需求-030**: 系统必须提供线框+着色渲染模式，结合两种可视化效果。
- **功能需求-031**: 系统必须显示当前活动渲染模式的视觉指示器。
- **功能需求-032**: 系统必须强制渲染模式之间的互斥性。

#### 视图聚焦

- **功能需求-033**: 系统必须在按下 F 键时将视图聚焦于选中的对象。
- **功能需求-034**: 系统必须在按下 Shift+F 时锁定视图以跟随选中的对象。
- **功能需求-035**: 系统必须在 Shift+点击坐标轴中心时将视图重置为默认透视角度。

#### 层级面板

- **功能需求-036**: 系统必须在可折叠的树状结构中显示所有场景对象。
- **功能需求-037**: 系统必须支持拖放以更改对象父子关系。
- **功能需求-038**: 系统必须以独特的视觉样式高亮显示选中的对象。
- **功能需求-039**: 系统必须在对象名称旁显示对象类型图标。

#### 检查器面板

- **功能需求-040**: 系统必须为选中对象显示变换组件（位置、旋转、缩放）。
- **功能需求-041**: 系统必须允许对所有变换值进行带有 XYZ 标签的数字输入。
- **功能需求-042**: 系统必须为选中对象显示带有视觉滑块的材质属性。
- **功能需求-043**: 系统必须显示数字孪生数据部分，包括外部 ID、实时值和连接状态。
- **功能需求-044**: 系统必须在对象变换时实时更新检查器值。
- **功能需求-045**: 系统必须允许通过 F2 或直接名称输入重命名对象。

#### 项目面板

- **功能需求-046**: 系统必须提供项目标签页，显示项目资产文件夹树（从静态本地文件加载）。
- **功能需求-047**: 系统必须提供资源标签页，显示公共资产库。
- **功能需求-048**: 系统必须在内容区域显示带有文件类型指示器的资产缩略图。
- **功能需求-049**: 系统必须支持从项目面板拖放到场景视图以进行实例化。

#### 对象操作

- **功能需求-050**: 系统必须支持通过 Ctrl+D 复制对象。
- **功能需求-051**: 系统必须支持通过 Delete 键删除对象（需确认）。
- **功能需求-052**: 系统必须支持通过 Shift+Delete 立即删除对象（无确认）。
- **功能需求-053**: 系统必须支持通过 Ctrl+Shift+Z 重置变换。
- **功能需求-054**: 系统必须支持通过 Ctrl+Z 撤销。
- **功能需求-055**: 系统必须支持通过 Ctrl+Y 重做。

#### 跨平台

- **功能需求-056**: 系统必须适配 Mac 的键盘快捷键（Ctrl→Command，Alt→Option）。
- **功能需求-057**: 系统必须支持带有响应式布局的窗口调整大小。
- **功能需求-058**: 系统必须通过禁用视图旋转和飞行漫游导航来限制 2D 模式。

#### 技术栈 (Technical Constraints)

- **技术约束-001**: 必须使用 **React + Three.js (React Three Fiber)** 作为前端框架和 3D 渲染引擎。
- **技术约束-002**: 必须使用 **Zustand** (轻量级状态管理) 来同步编辑器状态（替代 Redux/Context）。
- **技术约束-003**: 必须使用 **Instanced Mesh Rendering** 技术来处理相同几何体/材质的对象，以确保支持 1000+ 对象时的 60fps 性能。
- **技术约束-004**: 必须使用 **Tailwind CSS** 作为 UI 样式框架，以匹配提供的设计样本。

---

## 关键实体

### SceneObject (场景对象)
代表 3D 场景中的任何对象。包含变换属性（位置、旋转、缩放）、名称、可见性状态和父子关系。

### Transform (变换)
附加到每个 SceneObject 的组件，定义其空间属性：位置 (X,Y,Z)、旋转 (X,Y,Z)、缩放 (X,Y,Z)。

### Material (材质)
应用于对象的视觉属性，定义外观：基础颜色、粗糙度、金属度、纹理。

### DigitalTwinData (数字孪生数据)
将 SceneObject 链接到外部 IoT/数字孪生系统的元数据：外部 ID、实时传感器值（温度、状态）、连接状态、最后更新时间戳。

### Asset (资产)
项目或库中的资源文件：3D 模型 (.fbx, .glb, .gltf)、材质 (.mat)、场景文件 (.json)、纹理。

### Scene (场景)
包含层级结构的所有 SceneObject 的容器，保存为 JSON 文件，包含对象定义、变换、材质和数字孪生引用。

---

## 成功标准 *(必填)*

### 可衡量的结果

- **成功标准-001**: 用户可以在每次交互 100 毫秒响应时间内导航任何场景视图（旋转、平移、缩放）。
- **成功标准-002**: 用户可以通过单击选择对象，并在 100 毫秒内在层级中看到同步高亮显示。
- **成功标准-003**: 用户可以使用键盘快捷键在所有 5 个变换工具 (Q/W/E/R/Y) 之间切换，无明显延迟。
- **成功标准-004**: 场景在最多可见 1000 个对象的情况下以最低 60fps 渲染。
- **成功标准-005**: 用户可以在 30 秒内完成基本的对象放置任务（选择工具、定位对象、确认）。
- **成功标准-006**: 所有视觉反馈（工具激活、选择高亮、光标更改）在用户操作后 100 毫秒内出现。
- **成功标准-007**: 变换 Gizmo 正确显示与坐标系方向匹配的轴颜色（红-X，绿-Y，蓝-Z）。
- **成功标准-008**: 用户可以撤销/重做至少 50 个连续操作而不丢失数据。
- **成功标准-009**: 当用户拖动对象时，检查器面板实时更新变换值，无明显延迟。
- **成功标准-010**: 90% 的首次用户可以在不查阅文档的情况下成功导航、选择和变换对象。

---

## 假设条件

基于行业标准和背景做出了以下合理的默认值和假设：

1. **目标平台**: 支持 WebGL 2.0 的现代桌面 Web 浏览器（Chrome, Firefox, Edge, Safari）。

2. **输入设备**: 需要带滚轮的鼠标和键盘；触摸板和触摸屏支持不在初始范围内。

3. **坐标系**: 采用 Y 轴向上的右手坐标系（X-右，Y-上，Z-前），与大多数 3D 软件一致。

4. **文件格式**: 场景文件存储为 JSON；3D 模型支持 FBX, GLB, GLTF 格式。

5. **撤销历史**: 撤销/重做堆栈每会话维持至少 50 个操作；关闭场景时清除历史记录。

6. **实时数据轮询**: 数字孪生数据通过 WebSocket 或轮询机制以 1 秒间隔刷新（使用模拟数据源）。

7. **默认渲染模式**: 加载场景时默认为着色模式。

8. **默认工具**: 加载场景时默认激活抓手工具 (Q)。

9. **选择限制**: 对同时选中的对象数量没有人为限制。

10. **主题**: UI 参考中显示的深色主题是初始范围内默认且唯一的主题。

11. **撤销范围**: 撤销/重做系统仅跟踪场景数据更改（变换、选择、层级、属性），明确排除相机视图导航更改（旋转/缩放/平移视图不进入撤销栈）。

---

## 澄清记录

### Session 2026-01-20

- Q: 数字孪生实时数据源 → A: 模拟数据生成器 (Mock Data Generator)
- Q: 项目资产存储机制 → A: 静态本地文件 (Static Local Files)
- Q: Which technology stack should be used for the frontend and 3D engine? → A: React + Three.js (React Three Fiber)
- Q: What should be the scope of the Undo/Redo history system? → A: Exclude Camera/View Changes
- Q: Which rendering strategy should be used to support high object counts (1000+)? → A: Instanced Rendering
- Q: How should the 'Save Scene' functionality be implemented? → A: Browser File Download
- Q: Which state management library should be used? → A: Zustand
- Q: Which CSS framework should be used for styling the UI? → A: Tailwind CSS
